<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <link rel="icon" href="assets/img/favicon.ico" sizes="any">
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="assets/img/apple-touch-icon.png">
  <meta property="og:image" content="https://earthbackproject.org/assets/img/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Visualizer ‚Äî Earthback</title>
    <meta name="description" content="Describe the home, workshop, or community space you're imagining ‚Äî our AI renders it in the materials and methods this community actually uses.">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           EARTHBACK ¬∑ AI Visualizer
           Consistent with v2.0 brand system
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

        :root {
            --green:      #1F3A2E;
            --green-mid:  #2C4F3B;
            --green-soft: #4A7C5E;
            --clay:       #C2A56C;
            --clay-dark:  #8A5B3F;
            --clay-rust:  #A05E3A;
            --moss:       #7e9b73;
            --parchment:  #F2EFE6;
            --parchment2: #EAE3D3;
            --ink:        #2B2E30;
            --ink-soft:   #555A5C;
            --white:      #FFFFFF;
            --ease:       cubic-bezier(0.4, 0, 0.2, 1);
            --max:        1200px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--parchment);
            color: var(--ink);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
        }

        /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
        nav {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            background: rgba(20, 38, 28, 0.97);
            backdrop-filter: blur(14px);
            border-bottom: 1px solid rgba(194, 165, 108, 0.12);
        }
        .nav-inner {
            max-width: var(--max); margin: 0 auto;
            padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem; font-weight: 700;
            color: var(--parchment); text-decoration: none;
            letter-spacing: 0.1em; text-transform: uppercase;
        }
        .nav-logo .brand-back { color: var(--clay); }
        .brand-the {
            font-size: 0.5em; font-weight: 300;
            color: rgba(242,239,230,0.52); text-transform: lowercase;
            letter-spacing: 0.03em; vertical-align: 0.22em; margin-right: 0.18em;
        }
        .brand-back { color: var(--clay); }
        .brand-project {
            font-size: 0.46em; font-weight: 400;
            color: rgba(242,239,230,0.35); text-transform: uppercase;
            letter-spacing: 0.25em; vertical-align: 0.24em;
        }
        nav ul { display: flex; gap: 1rem; list-style: none; align-items: center; }
        nav a {
            color: rgba(242,239,230,0.78); text-decoration: none;
            font-size: 0.875rem; font-weight: 500;
            transition: color 0.2s var(--ease);
        }
        nav a:hover { color: var(--clay); }
        nav a.active { color: var(--clay); font-weight: 600; }
        .nav-join {
            background: var(--clay); color: var(--green) !important;
            padding: 0.55rem 1.35rem; border-radius: 3px;
            font-weight: 700 !important;
            transition: background 0.2s var(--ease) !important;
        }
        .nav-join:hover { background: var(--parchment) !important; }

        /* ‚îÄ‚îÄ MOBILE NAV ‚îÄ‚îÄ */
        .nav-hamburger {
            display: none; flex-direction: column; gap: 5px;
            background: none; border: none; cursor: pointer; padding: 4px;
        }
        .nav-hamburger span {
            display: block; width: 22px; height: 2px;
            background: var(--parchment); border-radius: 2px;
            transition: all 0.25s;
        }
        .nav-hamburger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        .nav-hamburger.open span:nth-child(2) { opacity: 0; }
        .nav-hamburger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
        .mobile-nav-overlay {
            display: none; position: fixed; top: 56px; left: 0; right: 0; bottom: 0;
            background: rgba(9,18,13,0.98); z-index: 999;
            flex-direction: column; padding: 2rem; gap: 0;
        }
        .mobile-nav-overlay.open { display: flex; }
        .mobile-nav-overlay a {
            font-size: 1.4rem; color: rgba(242,239,230,0.8);
            text-decoration: none; padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            font-family: 'Cormorant Garamond', serif; font-weight: 600;
            transition: color 0.15s;
        }
        .mobile-nav-overlay a:hover { color: var(--clay); }
        .mobile-nav-overlay a.join-mobile {
            margin-top: 1.5rem; border: none;
            background: var(--clay); color: var(--green) !important;
            text-align: center; border-radius: 3px;
            font-family: 'Inter', sans-serif; font-size: 1rem;
            font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase;
            padding: 1rem;
        }
        @media (max-width: 860px) { .nav-hamburger { display: flex; } nav ul { display: none !important; } }

        /* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
        .page-container {
            max-width: var(--max); margin: 0 auto;
            padding: 7rem 2rem 4rem;
        }

        /* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
        .page-header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--parchment2);
        }
        .badge {
            display: inline-flex; align-items: center; gap: 0.4rem;
            background: rgba(74,124,94,0.12); color: var(--green-soft);
            padding: 0.35rem 0.9rem; border-radius: 20px;
            font-size: 0.72rem; font-weight: 600;
            letter-spacing: 0.12em; text-transform: uppercase;
            margin-bottom: 1rem;
        }
        .badge .dot {
            width: 6px; height: 6px;
            background: var(--green-soft); border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .page-header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(2rem, 4vw, 2.8rem);
            font-weight: 700; color: var(--ink);
            line-height: 1.15; margin-bottom: 0.6rem;
        }
        .page-header h1 em { font-style: italic; color: var(--green-soft); }
        .page-header p {
            color: var(--ink-soft); font-size: 1.05rem;
            max-width: 560px; margin: 0 auto;
        }

        /* ‚îÄ‚îÄ MAIN GRID ‚îÄ‚îÄ */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem; align-items: start;
            margin-bottom: 1.5rem;
        }

        /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
        .card {
            background: var(--white);
            border: 1px solid var(--parchment2);
            border-radius: 10px;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--parchment2);
            display: flex; align-items: center; justify-content: space-between;
        }
        .card-header h3 {
            font-size: 0.88rem; font-weight: 600; color: var(--ink);
        }
        .free-counter {
            font-size: 0.72rem; color: var(--green-soft);
            background: rgba(74,124,94,0.1);
            padding: 0.25rem 0.65rem; border-radius: 10px; font-weight: 600;
        }
        .card-body { padding: 1.25rem; }

        /* ‚îÄ‚îÄ FORM FIELDS ‚îÄ‚îÄ */
        .field-group { margin-bottom: 1.25rem; }
        .field-label {
            display: block; font-size: 0.72rem; font-weight: 600;
            color: var(--ink-soft); text-transform: uppercase;
            letter-spacing: 0.08em; margin-bottom: 0.5rem;
        }
        .chips { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        .chip {
            padding: 0.35rem 0.75rem; border-radius: 4px;
            border: 1px solid var(--parchment2); background: var(--parchment);
            font-size: 0.82rem; color: var(--ink-soft); cursor: pointer;
            transition: all 0.15s ease; font-weight: 500; user-select: none;
        }
        .chip:hover { border-color: var(--green-soft); color: var(--green); }
        .chip.selected {
            border-color: var(--green-soft); background: rgba(74,124,94,0.1);
            color: var(--green); font-weight: 600;
        }

        .prompt-input {
            width: 100%; min-height: 130px;
            padding: 0.9rem 1rem;
            border: 1px solid var(--parchment2); border-radius: 6px;
            font-family: 'Inter', sans-serif; font-size: 0.92rem;
            color: var(--ink); background: var(--parchment);
            resize: vertical; line-height: 1.6;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .prompt-input:focus {
            outline: none; border-color: var(--green-soft);
            box-shadow: 0 0 0 3px rgba(74,124,94,0.1);
        }
        .prompt-input::placeholder { color: #aaa; }

        .style-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .style-option {
            padding: 0.65rem 0.5rem; border-radius: 6px;
            border: 1px solid var(--parchment2); background: var(--white);
            text-align: center; cursor: pointer; transition: all 0.15s ease;
        }
        .style-option:hover { border-color: var(--green-soft); }
        .style-option.selected {
            border-color: var(--green-soft); background: rgba(74,124,94,0.1);
        }
        .style-option .icon { font-size: 1.3rem; margin-bottom: 0.2rem; }
        .style-option .label { display: block; font-size: 0.75rem; font-weight: 600; }

        .generate-btn {
            width: 100%; padding: 0.85rem;
            border: none; border-radius: 4px;
            background: var(--green); color: var(--parchment);
            font-family: 'Inter', sans-serif; font-size: 0.92rem;
            font-weight: 700; cursor: pointer; letter-spacing: 0.03em;
            transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            margin-top: 0.25rem; text-transform: uppercase;
        }
        .generate-btn:hover { background: var(--clay-rust); }
        .generate-btn:disabled {
            opacity: 0.5; cursor: not-allowed;
        }
        .generate-btn:disabled:hover { background: var(--green); }
        .generate-btn svg { width: 16px; height: 16px; }

        /* ‚îÄ‚îÄ PROMPT HINTS ‚îÄ‚îÄ */
        .hints-toggle {
            display: inline-flex; align-items: center; gap: 0.35rem;
            background: none; border: 1px solid rgba(194,165,108,0.3);
            border-radius: 20px; padding: 0.25rem 0.75rem;
            font-family: 'Inter', sans-serif; font-size: 0.72rem;
            font-weight: 600; color: var(--clay-dark); cursor: pointer;
            transition: all 0.2s; letter-spacing: 0.02em;
        }
        .hints-toggle:hover { border-color: var(--clay); color: var(--clay-rust); background: rgba(194,165,108,0.06); }
        .hints-toggle.active { border-color: var(--green-soft); color: var(--green); background: rgba(74,124,94,0.06); }
        .hints-toggle svg { width: 13px; height: 13px; transition: transform 0.2s; }
        .hints-toggle.active svg { transform: rotate(180deg); }

        .hints-panel {
            display: none; margin-top: 0.75rem;
            background: linear-gradient(135deg, rgba(31,58,46,0.04) 0%, rgba(194,165,108,0.06) 100%);
            border: 1px solid rgba(194,165,108,0.2);
            border-radius: 10px; overflow: hidden;
            animation: hintsSlideIn 0.25s ease;
        }
        .hints-panel.open { display: block; }
        @keyframes hintsSlideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hints-tabs {
            display: flex; gap: 0; border-bottom: 1px solid rgba(194,165,108,0.15);
            overflow-x: auto; -webkit-overflow-scrolling: touch;
        }
        .hints-tab {
            padding: 0.55rem 0.85rem; border: none; background: none;
            font-family: 'Inter', sans-serif; font-size: 0.7rem;
            font-weight: 600; color: var(--ink-soft); cursor: pointer;
            white-space: nowrap; transition: all 0.15s;
            border-bottom: 2px solid transparent;
            letter-spacing: 0.03em;
        }
        .hints-tab:hover { color: var(--green); }
        .hints-tab.active {
            color: var(--green); border-bottom-color: var(--green-soft);
            background: rgba(74,124,94,0.04);
        }

        .hints-content { padding: 0.85rem 1rem; min-height: 140px; }
        .hints-card {
            display: none; animation: hintFade 0.3s ease;
        }
        .hints-card.active { display: block; }
        @keyframes hintFade {
            from { opacity: 0; } to { opacity: 1; }
        }

        .hint-tip {
            display: flex; gap: 0.65rem; align-items: flex-start;
            padding: 0.55rem 0; border-bottom: 1px solid rgba(194,165,108,0.1);
        }
        .hint-tip:last-child { border-bottom: none; }
        .hint-icon {
            width: 22px; height: 22px; border-radius: 6px;
            background: rgba(74,124,94,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; flex-shrink: 0; margin-top: 1px;
        }
        .hint-text { font-size: 0.8rem; color: var(--ink); line-height: 1.5; }
        .hint-text strong { color: var(--green); font-weight: 600; }
        .hint-text code {
            font-size: 0.74rem; background: rgba(31,58,46,0.06);
            padding: 0.1rem 0.35rem; border-radius: 3px;
            color: var(--clay-dark); font-family: 'Inter', sans-serif;
            font-style: italic;
        }

        .hint-example {
            margin-top: 0.6rem; padding: 0.6rem 0.75rem;
            background: rgba(31,58,46,0.05); border-radius: 6px;
            border-left: 3px solid var(--green-soft);
        }
        .hint-example-label {
            font-size: 0.62rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.1em; color: var(--green-soft); margin-bottom: 0.3rem;
        }
        .hint-example-text {
            font-size: 0.78rem; color: var(--ink); line-height: 1.5;
            font-style: italic;
        }
        .hint-try-btn {
            display: inline-flex; align-items: center; gap: 0.3rem;
            margin-top: 0.4rem; padding: 0.25rem 0.6rem;
            background: var(--green); color: var(--parchment);
            border: none; border-radius: 4px;
            font-family: 'Inter', sans-serif; font-size: 0.68rem;
            font-weight: 600; cursor: pointer; transition: background 0.15s;
        }
        .hint-try-btn:hover { background: var(--clay-rust); }

        .hints-footer {
            padding: 0.5rem 1rem;
            border-top: 1px solid rgba(194,165,108,0.12);
            display: flex; justify-content: space-between; align-items: center;
        }
        .hints-shuffle {
            display: inline-flex; align-items: center; gap: 0.35rem;
            background: none; border: none; font-family: 'Inter', sans-serif;
            font-size: 0.72rem; font-weight: 600; color: var(--green-soft);
            cursor: pointer; transition: color 0.15s; padding: 0.2rem 0;
        }
        .hints-shuffle:hover { color: var(--clay-rust); }
        .hints-shuffle svg { width: 14px; height: 14px; }
        .hints-counter {
            font-size: 0.68rem; color: var(--ink-soft);
        }

        /* ‚îÄ‚îÄ IMAGE PANEL ‚îÄ‚îÄ */
        .image-area {
            aspect-ratio: 4 / 3;
            background: var(--parchment);
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .placeholder { text-align: center; padding: 2rem; }
        .placeholder-ring {
            width: 64px; height: 64px; margin: 0 auto 1rem;
            border-radius: 50%; border: 2px dashed var(--parchment2);
            display: flex; align-items: center; justify-content: center;
        }
        .placeholder-ring svg { width: 24px; height: 24px; opacity: 0.35; color: var(--ink-soft); }
        .placeholder h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.3rem; }
        .placeholder p { font-size: 0.82rem; color: var(--ink-soft); max-width: 280px; margin: 0 auto; }

        .loading-overlay {
            display: none; position: absolute; inset: 0;
            background: rgba(31, 58, 46, 0.92);
            align-items: center; justify-content: center;
            flex-direction: column; gap: 1rem; z-index: 2;
        }
        .loading-overlay.active { display: flex; }
        .spinner {
            width: 36px; height: 36px;
            border: 2.5px solid rgba(242,239,230,0.2);
            border-top-color: var(--clay);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay span { color: rgba(242,239,230,0.75); font-size: 0.85rem; }

        .generated-image {
            display: none; width: 100%; height: 100%;
            object-fit: cover;
        }

        .image-toolbar {
            padding: 0.75rem 1.25rem;
            border-top: 1px solid var(--parchment2);
            display: flex; align-items: center; justify-content: space-between;
        }
        .toolbar-group { display: flex; gap: 0.4rem; }
        .tool-btn {
            padding: 0.4rem 0.7rem; border-radius: 4px;
            border: 1px solid var(--parchment2); background: var(--white);
            font-family: 'Inter', sans-serif; font-size: 0.75rem; font-weight: 500;
            color: var(--ink-soft); cursor: pointer; transition: all 0.15s;
            display: flex; align-items: center; gap: 0.3rem;
        }
        .tool-btn:hover { border-color: var(--green-soft); color: var(--green); }
        .tool-btn.filled {
            background: var(--green); color: var(--parchment); border-color: var(--green);
        }
        .tool-btn.filled:hover { background: var(--clay-rust); border-color: var(--clay-rust); }

        .save-hint {
            font-size: 0.78rem;
            color: var(--ink-soft);
            text-align: right;
            margin-top: 0.4rem;
            line-height: 1.4;
        }
        .save-hint a {
            color: var(--green-soft);
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }

        /* ‚îÄ‚îÄ REFINE BAR ‚îÄ‚îÄ */
        .refine-bar { margin-bottom: 2rem; }
        .refine-inner {
            background: var(--white);
            border: 1px solid var(--parchment2); border-radius: 10px;
            padding: 0.75rem 1rem;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .refine-label {
            font-size: 0.72rem; font-weight: 600;
            color: var(--ink-soft); text-transform: uppercase;
            letter-spacing: 0.08em; white-space: nowrap;
        }
        .refine-input {
            flex: 1; padding: 0.5rem 0.75rem;
            border: 1px solid var(--parchment2); border-radius: 4px;
            font-family: 'Inter', sans-serif; font-size: 0.88rem;
            background: var(--parchment); color: var(--ink); transition: border-color 0.2s;
        }
        .refine-input:focus { outline: none; border-color: var(--green-soft); }
        .refine-input::placeholder { color: #aaa; }
        .refine-send {
            padding: 0.5rem 1rem; border: none; border-radius: 4px;
            background: var(--green); color: var(--parchment);
            font-family: 'Inter', sans-serif; font-size: 0.82rem;
            font-weight: 600; cursor: pointer; text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .refine-send:hover { background: var(--clay-rust); }

        /* ‚îÄ‚îÄ UPGRADE CTA ‚îÄ‚îÄ */
        .upgrade-cta {
            background: var(--white);
            border: 1px solid var(--parchment2); border-radius: 10px;
            padding: 2rem 2.5rem;
            display: flex; align-items: center; justify-content: space-between; gap: 2rem;
        }
        .upgrade-cta h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem; font-weight: 700; margin-bottom: 0.3rem;
        }
        .upgrade-cta p { color: var(--ink-soft); font-size: 0.92rem; }
        .upgrade-btn {
            padding: 0.7rem 1.5rem;
            border: 2px solid var(--green); border-radius: 4px;
            background: transparent; color: var(--green);
            font-family: 'Inter', sans-serif; font-size: 0.88rem;
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            white-space: nowrap; text-transform: uppercase; letter-spacing: 0.03em;
        }
        .upgrade-btn:hover { background: var(--green); color: var(--parchment); }

        /* ‚îÄ‚îÄ PROFILE HINT ‚îÄ‚îÄ */
        .profile-hint {
            margin-top: 1.5rem; text-align: center;
            padding: 1.25rem;
            background: rgba(194,165,108,0.08);
            border: 1px solid rgba(194,165,108,0.2);
            border-radius: 10px;
        }
        .profile-hint p { font-size: 0.88rem; color: var(--ink-soft); }
        .profile-hint strong { color: var(--clay-dark); }

        /* ‚îÄ‚îÄ VISION GALLERY ‚îÄ‚îÄ */
        .visions-gallery {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(194,165,108,0.2);
        }
        .visions-gallery-header {
            display: flex; justify-content: space-between; align-items: baseline;
            margin-bottom: 1.2rem;
        }
        .visions-gallery-header h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem; font-weight: 600; color: var(--ink);
        }
        .visions-gallery-header span {
            font-size: 0.78rem; color: var(--ink-soft);
        }
        .visions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px;
        }
        .vision-card {
            background: var(--white); border: 1px solid rgba(194,165,108,0.15);
            border-radius: 10px; overflow: hidden;
            box-shadow: 0 1px 6px rgba(0,0,0,0.06);
            cursor: pointer; transition: all 0.2s;
            position: relative;
        }
        .vision-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        .vision-card img {
            width: 100%; height: 160px; object-fit: cover; display: block;
        }
        .vision-card-body {
            padding: 10px 12px;
        }
        .vision-card-prompt {
            font-size: 0.8rem; color: var(--ink);
            line-height: 1.4; display: -webkit-box;
            -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; margin-bottom: 6px;
        }
        .vision-card-meta {
            display: flex; justify-content: space-between; align-items: center;
        }
        .vision-card-chips {
            display: flex; gap: 4px; flex-wrap: wrap;
        }
        .vision-card-chip {
            font-size: 0.65rem; font-weight: 600; padding: 2px 6px;
            border-radius: 4px; background: rgba(31,58,46,0.06); color: var(--ink-soft);
        }
        .vision-card-date {
            font-size: 0.68rem; color: rgba(0,0,0,0.35);
        }
        .vision-card-delete {
            position: absolute; top: 6px; right: 6px;
            width: 24px; height: 24px; border-radius: 50%;
            background: rgba(0,0,0,0.5); color: white;
            border: none; font-size: 0.85rem; cursor: pointer;
            display: none; align-items: center; justify-content: center;
            line-height: 1;
        }
        .vision-card:hover .vision-card-delete { display: flex; }
        .vision-card-delete:hover { background: rgba(160,94,58,0.8); }

        .vision-card-share {
            display: flex; align-items: center; gap: 4px;
            background: none; border: 1px solid var(--parchment2);
            border-radius: 6px; padding: 3px 10px;
            font-size: 0.72rem; color: var(--ink-soft);
            cursor: pointer; transition: all 0.15s;
            margin-top: 6px;
        }
        .vision-card-share:hover {
            border-color: var(--green-soft); color: var(--green-soft);
        }
        .vision-card-share.shared {
            border-color: var(--green-soft); color: var(--green-soft);
            cursor: default; font-weight: 500;
        }
        .vision-card-share .share-icon {
            width: 12px; height: 12px;
        }
        .vision-card-likes {
            font-size: 0.72rem; color: var(--ink-soft);
            margin-top: 4px; display: flex; align-items: center; gap: 4px;
        }
        .vision-card-likes .heart-sm {
            width: 12px; height: 12px; fill: var(--clay-rust); stroke: none;
        }

        .visions-empty {
            text-align: center; padding: 2rem;
            color: var(--ink-soft); font-size: 0.88rem;
        }

        /* ‚îÄ‚îÄ ERROR MESSAGE ‚îÄ‚îÄ */
        .error-toast {
            display: none; position: fixed; bottom: 2rem; left: 50%;
            transform: translateX(-50%);
            background: var(--clay-rust); color: var(--white);
            padding: 0.75rem 1.5rem; border-radius: 6px;
            font-size: 0.88rem; font-weight: 500; z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .error-toast.active { display: block; }

        /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
        footer {
            background: #0e1e15; padding: 3rem 2rem; text-align: center;
        }
        .footer-logo {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem; font-weight: 700;
            color: var(--parchment); text-decoration: none;
            letter-spacing: 0.1em; text-transform: uppercase;
            display: block; margin-bottom: 1rem;
        }
        .footer-logo .brand-back { color: var(--clay); }
        .footer-links {
            list-style: none; display: flex; justify-content: center;
            gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;
        }
        .footer-links a {
            color: rgba(242,239,230,0.55); text-decoration: none;
            font-size: 0.82rem; transition: color 0.2s;
        }
        .footer-links a:hover { color: var(--clay); }
        .footer-copy { font-size: 0.78rem; color: rgba(242,239,230,0.3); }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .page-header h1 { font-size: 1.75rem; }
            .upgrade-cta { flex-direction: column; text-align: center; }
            .page-container { padding: 6rem 1rem 3rem; }
        }
    </style>
</head>
<body>

<div id="site-nav"></div>


<div class="page-container">

    <div class="page-header">
        <div class="badge"><span class="dot"></span> AI Preview</div>
        <h1>Envision your <em>build.</em></h1>
        <p>Describe the home, workshop, or community space you're imagining ‚Äî our AI renders it in the materials and methods this community actually uses.</p>
    </div>

    <div class="main-grid">

        <!-- LEFT: PROMPT -->
        <div class="card">
            <div class="card-header">
                <h3>Describe your project</h3>
                <span class="free-counter" id="renderCounter">25 credits</span>
            </div>
            <div class="card-body">
                <div class="field-group">
                    <span class="field-label">Structure</span>
                    <div class="chips" id="structureChips">
                        <span class="chip selected" data-value="single-home">Single Home</span>
                        <span class="chip" data-value="duplex">Duplex</span>
                        <span class="chip" data-value="community-hub">Community Hub</span>
                        <span class="chip" data-value="workshop">Workshop</span>
                        <span class="chip" data-value="full-village">Full Village</span>
                    </div>
                </div>

                <div class="field-group">
                    <span class="field-label">Climate / Region</span>
                    <div class="chips" id="climateChips">
                        <span class="chip selected" data-value="high-desert">High Desert</span>
                        <span class="chip" data-value="prairie">Prairie</span>
                        <span class="chip" data-value="forest">Forest</span>
                        <span class="chip" data-value="coastal">Coastal</span>
                        <span class="chip" data-value="mountain">Mountain</span>
                        <span class="chip" data-value="tropical">Tropical</span>
                    </div>
                </div>

                <div class="field-group">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
                        <span class="field-label" style="margin-bottom:0;">Your vision</span>
                        <button class="hints-toggle" id="hintsToggle" onclick="toggleHints()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 16.8l-6.2 4.5 2.4-7.4L2 9.4h7.6z" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            Prompt tips
                        </button>
                    </div>

                    <div class="hints-panel" id="hintsPanel">
                        <div class="hints-tabs" id="hintsTabs"></div>
                        <div class="hints-content" id="hintsContent"></div>
                        <div class="hints-footer">
                            <button class="hints-shuffle" onclick="shuffleHints()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                More tips
                            </button>
                            <span class="hints-counter" id="hintsCounter"></span>
                        </div>
                    </div>

                    <textarea class="prompt-input" id="promptInput" placeholder="A 1,200 sq ft rammed earth home with a living roof, passive solar orientation, large south-facing windows, a shaded courtyard with rainwater cisterns, native xeriscape plantings and a small hemp garden..."></textarea>
                </div>

                <div class="field-group">
                    <span class="field-label">Render style</span>
                    <div class="style-row" id="styleRow">
                        <div class="style-option selected" data-value="photorealistic">
                            <div class="icon">&#x1f4f7;</div>
                            <span class="label">Photorealistic</span>
                        </div>
                        <div class="style-option" data-value="sketch">
                            <div class="icon">&#x270f;&#xfe0f;</div>
                            <span class="label">Sketch</span>
                        </div>
                        <div class="style-option" data-value="blueprint">
                            <div class="icon">&#x1f4d0;</div>
                            <span class="label">Blueprint</span>
                        </div>
                    </div>
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateVision()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z"/></svg>
                    Generate vision
                </button>
            </div>
        </div>

        <!-- RIGHT: IMAGE -->
        <div class="card">
            <div class="image-area" id="imageArea">
                <div class="placeholder" id="placeholderState">
                    <div class="placeholder-ring">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.41a2.25 2.25 0 013.182 0l2.909 2.91M6.75 7.5a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM18 7.5a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/></svg>
                    </div>
                    <h4>Your vision will appear here</h4>
                    <p>Describe your project and hit generate to see it rendered in earth, hemp, and timber.</p>
                </div>

                <div class="loading-overlay" id="loadingState">
                    <div class="spinner"></div>
                    <span>Rendering your vision...</span>
                </div>

                <img class="generated-image" id="generatedImage" alt="AI-generated architectural visualization" />
            </div>

            <div class="image-toolbar">
                <div class="toolbar-group">
                    <button class="tool-btn" id="regenerateBtn" onclick="generateVision()">Regenerate</button>
                    <button class="tool-btn" id="variationsBtn" title="Coming with Pro">Variations</button>
                </div>
                <div class="toolbar-group">
                    <button class="tool-btn" id="downloadBtn" onclick="downloadImage()">Download</button>
                    <button class="tool-btn filled" id="saveBtn" onclick="saveToProfile()">Save to profile</button>
                </div>
            </div>
            <p class="save-hint" id="saveHint">Images aren't kept unless you save them. Saved visions appear in <a href="#visionsGallery" onclick="document.getElementById('visionsGallery').scrollIntoView({behavior:'smooth'})">your gallery</a> below.</p>
        </div>
    </div>

    <!-- REFINE BAR -->
    <div class="refine-bar">
        <div class="refine-inner">
            <span class="refine-label">Refine</span>
            <input type="text" class="refine-input" id="refineInput" placeholder="Add a greenhouse on the south side, make the roof steeper...">
            <button class="refine-send" onclick="refineVision()">Update</button>
        </div>
    </div>

    <!-- UPGRADE -->
    <div class="upgrade-cta">
        <div>
            <h3>Unlock unlimited visions</h3>
            <p>Unlimited renders, HD downloads, all three styles, and early access to the interactive builder.</p>
        </div>
        <button class="upgrade-btn">Coming soon</button>
    </div>

    <!-- VISION GALLERY -->
    <div class="visions-gallery" id="visionsGallery" style="display:none;">
        <div class="visions-gallery-header">
            <h3>Your visions</h3>
            <span id="visionsCount"></span>
        </div>
        <div class="visions-grid" id="visionsGrid"></div>
    </div>
</div>

<!-- ERROR TOAST -->
<div class="error-toast" id="errorToast"></div>

<div id="site-footer"></div>

<script>
    // ‚îÄ‚îÄ CHIP SELECTION ‚îÄ‚îÄ
    document.querySelectorAll('.chips').forEach(group => {
        group.querySelectorAll('.chip').forEach(chip => {
            chip.addEventListener('click', () => {
                group.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
            });
        });
    });

    document.querySelectorAll('.style-option').forEach(opt => {
        opt.addEventListener('click', () => {
            document.querySelectorAll('.style-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
        });
    });

    // ‚îÄ‚îÄ ROTATING CREDITS (localStorage) ‚îÄ‚îÄ
    // 1 credit every 2 hours (~12/day), max 25. Each render costs 1 credit.
    // Credits accrue while away ‚Äî full bar in ~2 days.
    // Leaving credits at 25 means you're "wasting" accrual ‚Üí come back!
    const CREDIT_KEY = 'earthback_viz_credits';
    const CREDITS_PER_HOUR = 0.5;
    const CREDIT_MAX = 25;
    const MS_PER_CREDIT = (60 * 60 * 1000) / CREDITS_PER_HOUR; // 2 hours per credit

    function getCredits() {
        try {
            const data = JSON.parse(localStorage.getItem(CREDIT_KEY) || 'null');
            if (!data || !data.lastCheck) {
                // First visit: start with full credits
                return { credits: CREDIT_MAX, lastCheck: Date.now() };
            }
            // Calculate accrued credits since last check
            const elapsed = Date.now() - data.lastCheck;
            const earned = Math.floor(elapsed / MS_PER_CREDIT);
            const newCredits = Math.min(CREDIT_MAX, data.credits + earned);
            // Only advance lastCheck by the credits we actually awarded
            const newLastCheck = data.lastCheck + (earned * MS_PER_CREDIT);
            return { credits: newCredits, lastCheck: newLastCheck };
        } catch {
            return { credits: CREDIT_MAX, lastCheck: Date.now() };
        }
    }

    function saveCredits(creditData) {
        localStorage.setItem(CREDIT_KEY, JSON.stringify(creditData));
    }

    function spendCredit() {
        const data = getCredits();
        if (data.credits <= 0) return false;
        data.credits--;
        data.lastCheck = Date.now(); // Anchor to now after spending
        // Recalculate: we need to preserve fractional accrual
        // Reset lastCheck to now so future accrual starts from this spend
        saveCredits(data);
        updateCounter();
        return true;
    }

    function incrementUsage() {
        spendCredit();
    }

    function formatCountdown(ms) {
        const totalMins = Math.ceil(ms / 60000);
        if (totalMins >= 60) {
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return m > 0 ? `${h}h ${m}m` : `${h}h`;
        }
        return `${totalMins}m`;
    }

    function updateCounter() {
        const data = getCredits();
        // Save the recalculated credits (with accrual) back
        saveCredits(data);
        const credits = data.credits;
        const counter = document.getElementById('renderCounter');

        if (credits >= CREDIT_MAX) {
            counter.textContent = `${credits} credits (full!)`;
            counter.style.color = 'var(--green-soft)';
            counter.style.background = 'rgba(74,124,94,0.1)';
        } else if (credits > 0) {
            // Show when next credit arrives
            const raw = JSON.parse(localStorage.getItem(CREDIT_KEY) || '{}');
            const elapsed = Date.now() - (raw.lastCheck || Date.now());
            const msUntilNext = Math.max(0, MS_PER_CREDIT - elapsed);
            counter.textContent = `${credits} credit${credits !== 1 ? 's' : ''} ¬∑ +1 in ${formatCountdown(msUntilNext)}`;
            counter.style.color = '';
            counter.style.background = '';
        } else {
            // Empty ‚Äî show time until next credit
            const raw = JSON.parse(localStorage.getItem(CREDIT_KEY) || '{}');
            const elapsed = Date.now() - (raw.lastCheck || Date.now());
            const msUntilNext = Math.max(0, MS_PER_CREDIT - elapsed);
            counter.textContent = `0 credits ¬∑ +1 in ${formatCountdown(msUntilNext)}`;
            counter.style.color = 'var(--clay-rust)';
            counter.style.background = 'rgba(160,94,58,0.1)';
        }
    }

    function canGenerate() {
        return getCredits().credits > 0;
    }

    // Init counter + refresh every 30s so the timer ticks down live
    updateCounter();
    setInterval(updateCounter, 30000);

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
    function getSelected(containerId) {
        const el = document.querySelector(`#${containerId} .selected`);
        return el ? el.dataset.value : null;
    }

    function getStyleSelected() {
        const el = document.querySelector('#styleRow .selected');
        return el ? el.dataset.value : 'photorealistic';
    }

    function showError(msg) {
        const toast = document.getElementById('errorToast');
        toast.textContent = msg;
        toast.classList.add('active');
        setTimeout(() => toast.classList.remove('active'), 4000);
    }

    // ‚îÄ‚îÄ KEEP TRACK OF LAST PROMPT FOR REFINEMENTS ‚îÄ‚îÄ
    let lastPrompt = '';
    let lastImageUrl = '';
    let lastFullPrompt = '';

    // ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ
    async function generateVision() {
        if (!canGenerate()) {
            showError('Out of credits ‚Äî you earn 1 every 2 hours. Check back soon!');
            return;
        }

        const prompt = document.getElementById('promptInput').value.trim();
        if (!prompt || prompt.length < 10) {
            showError('Describe your vision in at least a few words.');
            return;
        }

        const structure = getSelected('structureChips');
        const climate = getSelected('climateChips');
        const style = getStyleSelected();

        // UI states
        const btn = document.getElementById('generateBtn');
        const placeholder = document.getElementById('placeholderState');
        const loading = document.getElementById('loadingState');
        const img = document.getElementById('generatedImage');

        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Generating...';
        placeholder.style.display = 'none';
        img.style.display = 'none';
        loading.classList.add('active');

        try {
            const res = await fetch('/.netlify/functions/generate-vision', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, structure, climate, style })
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || 'Generation failed');
            }

            // Show the image
            img.src = data.image_url;
            img.onload = () => {
                loading.classList.remove('active');
                img.style.display = 'block';
            };
            img.onerror = () => {
                loading.classList.remove('active');
                placeholder.style.display = 'block';
                showError('Image failed to load. Try again.');
            };

            lastPrompt = prompt;
            lastImageUrl = data.image_url;
            lastFullPrompt = data.full_prompt || '';
            window.lastFullPrompt = lastFullPrompt;
            incrementUsage();

            // Reset save button for new image
            var saveBtn = document.getElementById('saveBtn');
            if (saveBtn) { saveBtn.textContent = 'Save to profile'; saveBtn.disabled = false; }

        } catch (err) {
            loading.classList.remove('active');
            placeholder.style.display = 'block';
            showError(err.message || 'Something went wrong. Please try again.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z"/></svg> Generate vision';
        }
    }

    // ‚îÄ‚îÄ REFINE ‚îÄ‚îÄ
    async function refineVision() {
        const refinement = document.getElementById('refineInput').value.trim();
        if (!refinement) return;

        // Append refinement to the original prompt and regenerate
        const promptInput = document.getElementById('promptInput');
        promptInput.value = lastPrompt + '. ' + refinement;
        document.getElementById('refineInput').value = '';
        await generateVision();
    }

    // ‚îÄ‚îÄ PROMPT HINTS SYSTEM ‚îÄ‚îÄ
    const HINT_CATEGORIES = [
        {
            id: 'basics',
            label: 'Basics',
            tips: [
                {
                    icon: 'üìê',
                    text: '<strong>Be specific about size.</strong> Mention square footage, number of rooms, and story count. The AI builds a much clearer image from <code>1,200 sq ft, 2 bed / 1 bath</code> than from "a small house."',
                    example: 'A 1,400 sq ft single-story hempcrete home with 3 bedrooms, open kitchen, and covered porch'
                },
                {
                    icon: 'üß≠',
                    text: '<strong>Describe the setting, not just the building.</strong> Place your structure in a landscape. What\'s around it? What time of day? What season? Context makes the render feel real.',
                    example: 'A rammed earth workshop nestled among pinon pines at the base of a mesa, golden hour light, late autumn'
                },
                {
                    icon: 'üì∑',
                    text: '<strong>Suggest a camera angle.</strong> Words like "aerial view," "street-level," "interior looking out through windows" dramatically change the composition.',
                    example: 'Aerial view of a full permaculture village with 8 hempcrete cottages around a central food forest and community kitchen'
                },
                {
                    icon: '‚úèÔ∏è',
                    text: '<strong>One sentence is enough to start.</strong> You don\'t need a paragraph. Start with a clear core idea and use the Refine bar to iterate. Short + specific beats long + vague.',
                    example: 'A tiny hempcrete cabin with a living roof, south-facing greenhouse wall, high desert'
                },
                {
                    icon: 'üé®',
                    text: '<strong>Mention materials by name.</strong> The AI knows hempcrete, rammed earth, cob, straw bale, reclaimed timber, lime plaster, earthen floors, and living roofs. Naming them brings out accurate textures.',
                    example: 'Cob walls with lime plaster finish, reclaimed Douglas fir beams, earthen floor with radiant heat'
                },
                {
                    icon: 'üîÑ',
                    text: '<strong>Use the Refine bar below the image.</strong> After your first render, tweak without starting over. Add details, change the angle, swap materials ‚Äî each refinement builds on what you\'ve got.',
                    example: null
                }
            ]
        },
        {
            id: 'materials',
            label: 'Materials',
            tips: [
                {
                    icon: 'üß±',
                    text: '<strong>Hempcrete shows best with wall thickness.</strong> Mention "thick hempcrete walls" or "12-inch hempcrete infill" ‚Äî it helps the AI render that distinctive chunky, organic texture.',
                    example: 'A two-story home with 12-inch hempcrete walls, exposed timber frame, deep window reveals, lime plaster exterior'
                },
                {
                    icon: 'üèîÔ∏è',
                    text: '<strong>Rammed earth loves horizontal layers.</strong> Say "rammed earth with visible strata" or "layered desert tones" to get those beautiful sedimentary bands.',
                    example: 'Rammed earth walls with red and ochre strata, passive solar orientation, clerestory windows, flat roof with PV panels'
                },
                {
                    icon: 'üåæ',
                    text: '<strong>Straw bale reads as soft and thick.</strong> Mention "deep windowsills" and "rounded plaster edges" for that authentic straw bale look ‚Äî soft curves, deep reveals, massive walls.',
                    example: 'A straw bale guest house with deep rounded windowsills, earthen plaster, wildflower green roof, timber lintels'
                },
                {
                    icon: 'ü™µ',
                    text: '<strong>Mix materials for realism.</strong> Real green buildings combine systems. Try "hempcrete walls with timber frame, stone foundation, and metal roof" ‚Äî the AI renders hybrid construction well.',
                    example: 'Post-and-beam timber frame with hempcrete infill, stone stem wall, standing seam metal roof, south-facing glazing'
                },
                {
                    icon: '<img src="assets/img/icons/icon-leaf.svg" style="width:1.2em;height:1.2em;">',
                    text: '<strong>Living roofs need plant details.</strong> Say "sedum green roof" or "wildflower meadow roof" or "native grasses" ‚Äî generic "green roof" often renders plain grass.',
                    example: 'An earthen workshop with a wildflower meadow roof, exposed round timber rafters, large barn doors, gravel courtyard'
                },
                {
                    icon: '‚ôªÔ∏è',
                    text: '<strong>Salvage and reclaimed materials add character.</strong> Mention "reclaimed barn wood siding," "salvaged windows," or "repurposed shipping containers" for that authentic builder aesthetic.',
                    example: 'A community tool library built from two repurposed shipping containers with reclaimed wood cladding and a butterfly roof'
                }
            ]
        },
        {
            id: 'systems',
            label: 'Systems',
            tips: [
                {
                    icon: '<img src="assets/img/icons/icon-sun.svg" style="width:1.2em;height:1.2em;">',
                    text: '<strong>Solar works best with specifics.</strong> Try "rooftop PV array," "solar thermal tubes on south wall," or "building-integrated PV shingles" rather than just "solar panels."',
                    example: 'An off-grid desert homestead with rooftop PV array, battery shed, solar water heater, and shaded outdoor kitchen'
                },
                {
                    icon: 'üíß',
                    text: '<strong>Water systems are visually rich.</strong> Mention "rainwater cisterns," "greywater reed bed," "rain chains," or "rooftop catchment" ‚Äî they add interesting structural elements.',
                    example: 'A hempcrete home with corrugated metal roof feeding twin stone rainwater cisterns, greywater garden beds along south wall'
                },
                {
                    icon: '<img src="assets/img/icons/icon-seedling.svg" style="width:1.2em;height:1.2em;">',
                    text: '<strong>Food systems around buildings look incredible.</strong> Try "food forest perimeter," "raised bed kitchen garden," "espalier fruit wall," or "aquaponics greenhouse attached."',
                    example: 'A community housing cluster surrounded by raised bed gardens, fruit tree guild, chicken run, and herb spiral near the kitchen'
                },
                {
                    icon: 'üå¨Ô∏è',
                    text: '<strong>Passive design features are renderable.</strong> "Thermal mass wall," "cross ventilation clerestory," "earth-bermed north wall," "Trombe wall" ‚Äî these create distinctive architectural features.',
                    example: 'A passive solar cob home with Trombe wall, earth-bermed north side, clerestory windows, thermal mass floor'
                },
                {
                    icon: 'üîã',
                    text: '<strong>Include infrastructure details.</strong> Battery banks, composting toilets, rocket mass heaters, outdoor bread ovens ‚Äî these practical elements ground the vision in reality.',
                    example: 'An off-grid workshop with rocket mass heater, tool wall, large workbench, battery bank corner, natural light from north clerestory'
                }
            ]
        },
        {
            id: 'composition',
            label: 'Composition',
            tips: [
                {
                    icon: 'üåÖ',
                    text: '<strong>Lighting sets the mood.</strong> "Golden hour," "morning mist," "dappled shade," "overcast diffused light" ‚Äî the AI responds strongly to lighting cues and renders them beautifully.',
                    example: 'A timber-frame community hall at golden hour, warm light streaming through clerestory windows, wood smoke from the chimney'
                },
                {
                    icon: 'üë•',
                    text: '<strong>Add people for scale and life.</strong> "A family on the porch," "builders working on the walls," "children in the garden" ‚Äî human figures make renders feel lived-in.',
                    example: 'A hempcrete build day with volunteers mixing hemp-lime, timber forms in place, partially completed walls, sunny afternoon'
                },
                {
                    icon: 'üè°',
                    text: '<strong>Interior views work too.</strong> Describe the inside: "open-plan kitchen with earthen plaster walls, exposed beams, south light pouring across a cob bench seat."',
                    example: 'Interior of a straw bale home, lime plastered walls, salvaged wood shelving, morning light through deep-set east window, handmade tile floor'
                },
                {
                    icon: 'üó∫Ô∏è',
                    text: '<strong>Site plans and village layouts.</strong> You can render from above: "site plan showing 6 hempcrete homes around a central green, community building at north end, parking grove."',
                    example: 'Aerial view of an intentional community: 12 small hempcrete homes in a horseshoe around a food forest, community barn, and pond'
                },
                {
                    icon: 'üîç',
                    text: '<strong>Zoom into details.</strong> Try "close-up of hempcrete wall texture," "detail of timber joinery," or "macro shot of living roof plants" for material-focused renders.',
                    example: 'Close-up detail of a rammed earth wall corner meeting a timber beam, showing the layered earth tones and grain of reclaimed oak'
                },
                {
                    icon: 'üåô',
                    text: '<strong>Night scenes create atmosphere.</strong> "Warm light glowing from windows at dusk," "string lights over the courtyard," "stars above the desert homestead" ‚Äî nighttime renders are striking.',
                    example: 'A hempcrete village at dusk, warm window glow, string lights over the courtyard, people gathered around an outdoor fire pit, stars emerging'
                }
            ]
        },
        {
            id: 'styles',
            label: 'Style Tips',
            tips: [
                {
                    icon: 'üì∏',
                    text: '<strong>Photorealistic works best for presentations.</strong> Use it when you want to show someone what your build could actually look like. Add "documentary photography style" for extra realism.',
                    example: 'Documentary photograph of a completed hempcrete home in rural New Mexico, family on porch, vegetable garden, mountain backdrop'
                },
                {
                    icon: '‚úèÔ∏è',
                    text: '<strong>Sketch mode is great for early concepts.</strong> Use it when you\'re still exploring ideas. It feels less "final" and invites conversation ‚Äî good for sharing with collaborators.',
                    example: 'Architectural sketch of a strawbale community center with large gathering hall, commercial kitchen, and covered outdoor workspace'
                },
                {
                    icon: 'üìê',
                    text: '<strong>Blueprint style for technical thinking.</strong> Good when you need to think about layout and proportions rather than aesthetics. Pair with "floor plan" or "section view."',
                    example: 'Blueprint floor plan of a 2-bedroom hempcrete home with passive solar orientation, root cellar, and attached greenhouse'
                },
                {
                    icon: 'üé≠',
                    text: '<strong>Combine style with mood words.</strong> Even within photorealistic, "warm and inviting" vs "stark and minimal" vs "lush and overgrown" produces very different results.',
                    example: 'A cozy, well-loved cob cottage overgrown with climbing roses, weathered wooden gate, herb garden path, warm smoke from chimney'
                },
                {
                    icon: '<img src="assets/img/icons/icon-chart.svg" style="width:1.2em;height:1.2em;">',
                    text: '<strong>Ready to estimate costs?</strong> Use the Visualizer to explore the look and feel, then jump to the <a href="designer.html" style="color:var(--green-soft);">Project Estimator</a> for real cost breakdowns, material quantities, and carbon calculations with a 3D preview.',
                    example: null
                }
            ]
        }
    ];

    let currentCategory = 0;
    let tipIndices = {};

    // Initialize: shuffle tip order per category
    function initHintIndices() {
        HINT_CATEGORIES.forEach(cat => {
            tipIndices[cat.id] = shuffleArray([...Array(cat.tips.length).keys()]);
            tipIndices[cat.id]._pos = 0;
        });
    }

    function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function toggleHints() {
        const panel = document.getElementById('hintsPanel');
        const toggle = document.getElementById('hintsToggle');
        const isOpen = panel.classList.contains('open');

        if (isOpen) {
            panel.classList.remove('open');
            toggle.classList.remove('active');
        } else {
            panel.classList.add('open');
            toggle.classList.add('active');
            if (!tipIndices || Object.keys(tipIndices).length === 0) {
                initHintIndices();
            }
            renderHintsTabs();
            renderHintsForCategory(currentCategory);
        }
    }

    function renderHintsTabs() {
        const tabsEl = document.getElementById('hintsTabs');
        tabsEl.innerHTML = HINT_CATEGORIES.map((cat, i) =>
            '<button class="hints-tab' + (i === currentCategory ? ' active' : '') + '" onclick="switchHintCategory(' + i + ')">' + cat.label + '</button>'
        ).join('');
    }

    function switchHintCategory(idx) {
        currentCategory = idx;
        renderHintsTabs();
        renderHintsForCategory(idx);
    }

    function renderHintsForCategory(catIdx) {
        const cat = HINT_CATEGORIES[catIdx];
        const indices = tipIndices[cat.id];
        const pos = indices._pos || 0;

        // Show 3 tips at a time
        const visibleTips = [];
        for (let i = 0; i < 3; i++) {
            const tipIdx = indices[(pos + i) % cat.tips.length];
            visibleTips.push(cat.tips[tipIdx]);
        }

        const contentEl = document.getElementById('hintsContent');
        contentEl.innerHTML = '<div class="hints-card active">' +
            visibleTips.map(tip => {
                let html = '<div class="hint-tip">' +
                    '<div class="hint-icon">' + tip.icon + '</div>' +
                    '<div><div class="hint-text">' + tip.text + '</div>';
                if (tip.example) {
                    html += '<div class="hint-example">' +
                        '<div class="hint-example-label">Try this</div>' +
                        '<div class="hint-example-text">' + tip.example + '</div>' +
                        '<button class="hint-try-btn" onclick="useExample(this)">Use this prompt</button>' +
                    '</div>';
                }
                html += '</div></div>';
                return html;
            }).join('') +
        '</div>';

        const counter = document.getElementById('hintsCounter');
        counter.textContent = cat.tips.length + ' tips in ' + cat.label;
    }

    function shuffleHints() {
        const cat = HINT_CATEGORIES[currentCategory];
        const indices = tipIndices[cat.id];
        indices._pos = ((indices._pos || 0) + 3) % cat.tips.length;
        renderHintsForCategory(currentCategory);
    }

    function useExample(btn) {
        const exampleText = btn.previousElementSibling.textContent;
        document.getElementById('promptInput').value = exampleText;
        document.getElementById('promptInput').focus();
        // Flash the textarea briefly
        const ta = document.getElementById('promptInput');
        ta.style.borderColor = 'var(--green-soft)';
        ta.style.boxShadow = '0 0 0 3px rgba(74,124,94,0.15)';
        setTimeout(() => { ta.style.borderColor = ''; ta.style.boxShadow = ''; }, 1200);
    }

    // ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ
    function downloadImage() {
        if (!lastImageUrl) {
            showError('Generate an image first.');
            return;
        }
        const a = document.createElement('a');
        a.href = lastImageUrl;
        a.download = 'earthback-vision.webp';
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // ‚îÄ‚îÄ SAVE TO PROFILE ‚îÄ‚îÄ
    function saveToProfile() {
        if (!lastImageUrl) {
            showError('Generate an image first.');
            return;
        }
        if (!window._vizSession) {
            showError('Sign in to save visions.');
            return;
        }
        // Trigger save immediately (doesn't wait for background)
        saveVisionToSupabase(lastImageUrl, lastFullPrompt);
    }

</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="assets/js/nav.js"></script>
<script src="assets/js/footer.js"></script>
<script>
// ‚îÄ‚îÄ SUPABASE CLIENT + AUTH + VISION PERSISTENCE ‚îÄ‚îÄ
(function() {
    var SUPABASE_URL = 'https://yptktmzagctusbeqdaty.supabase.co';
    var SUPABASE_KEY = 'sb_publishable_zp8dWs1CaN-A5oeR94qRdw_n7jNDhmC';
    var sb;
    try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { return; }

    // Expose for save functions
    window._vizSb = sb;
    window._vizSession = null;
    window.lastFullPrompt = '';

    sb.auth.getSession().then(async function(result) {
        var session = result.data.session;

        if (!session) {
            // ‚îÄ‚îÄ AUTH GATE ‚Äî visitors can browse but not generate ‚îÄ‚îÄ
            window._vizAuthGated = true;
            var btn = document.getElementById('generateBtn');
            if (btn) {
                btn.onclick = function(e) {
                    e.preventDefault();
                    showError('Sign in to generate visions.');
                    setTimeout(function() {
                        window.location.href = 'join.html?redirect=visualizer.html';
                    }, 1500);
                };
            }
            var counter = document.getElementById('renderCounter');
            if (counter) {
                counter.textContent = 'sign in to generate';
                counter.style.color = 'var(--clay-rust)';
            }
            return;
        }

        // ‚îÄ‚îÄ Signed in ‚Äî store session and load gallery ‚îÄ‚îÄ
        window._vizSession = session;

        // Update "Save to profile" button to be active
        var saveBtn = document.getElementById('saveBtn');
        if (saveBtn) {
            saveBtn.textContent = 'Save to profile';
            saveBtn.style.opacity = '1';
        }

        // Load existing visions
        loadVisionGallery(session.user.id);
        // Pick up any credits earned from likes (runs after gallery loads)
        setTimeout(function() { if (window._pickupLikeCredits) window._pickupLikeCredits(); }, 500);
    });

    // ‚îÄ‚îÄ LOAD VISION GALLERY ‚îÄ‚îÄ
    async function loadVisionGallery(userId) {
        var gallery = document.getElementById('visionsGallery');
        var grid = document.getElementById('visionsGrid');
        var countEl = document.getElementById('visionsCount');
        if (!gallery || !grid) return;

        var { data: visions, error } = await sb
            .from('visions')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false });

        if (error || !visions || visions.length === 0) {
            gallery.style.display = 'none';
            return;
        }

        gallery.style.display = 'block';
        countEl.textContent = visions.length + ' vision' + (visions.length !== 1 ? 's' : '');

        grid.innerHTML = visions.map(function(v, idx) {
            var dateStr = new Date(v.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            var promptSnippet = (v.prompt || '').substring(0, 100);
            var isShared = v.is_shared || false;
            var shareIcon = '<svg class="share-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            var likeCount = v.like_count || 0;
            var heartSvg = '<svg class="heart-sm" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';

            return '<div class="vision-card" data-vision-idx="' + idx + '" data-vision-id="' + v.id + '">' +
                (v.image_url ? '<img src="' + v.image_url + '" alt="Vision render" loading="lazy">' :
                    '<div style="height:160px;background:linear-gradient(135deg,#2a3a2a,#3a5a3a);display:flex;align-items:center;justify-content:center;"><img src="assets/img/icons/icon-building.svg" alt="" style="width:2rem;height:2rem;opacity:0.5;"></div>') +
                '<div class="vision-card-body">' +
                    '<div class="vision-card-prompt">' + promptSnippet + '</div>' +
                    '<div class="vision-card-meta">' +
                        '<div class="vision-card-chips">' +
                            '<span class="vision-card-chip">' + (v.structure || '').replace(/-/g, ' ') + '</span>' +
                            '<span class="vision-card-chip">' + (v.climate || '').replace(/-/g, ' ') + '</span>' +
                            '<span class="vision-card-chip">' + (v.style || '') + '</span>' +
                        '</div>' +
                        '<span class="vision-card-date">' + dateStr + '</span>' +
                    '</div>' +
                    (isShared
                        ? '<button class="vision-card-share shared" disabled>' + shareIcon + ' Shared</button>' +
                          (likeCount > 0 ? '<div class="vision-card-likes">' + heartSvg + ' ' + likeCount + '</div>' : '')
                        : '<button class="vision-card-share" data-share-id="' + v.id + '">' + shareIcon + ' Share to gallery</button>') +
                '</div>' +
                '<button class="vision-card-delete" onclick="event.stopPropagation();deleteVision(\'' + v.id + '\')" title="Delete">√ó</button>' +
            '</div>';
        }).join('');

        // Attach click handlers via JS (avoids HTML attribute escaping issues)
        grid.querySelectorAll('.vision-card').forEach(function(card) {
            var idx = parseInt(card.dataset.visionIdx);
            var v = visions[idx];
            card.addEventListener('click', function(e) {
                // Don't repopulate if clicking share or delete buttons
                if (e.target.closest('[data-share-id]') || e.target.closest('.vision-card-delete')) return;
                repopulateVision(JSON.stringify({
                    prompt: v.prompt || '',
                    structure: v.structure || 'single-home',
                    climate: v.climate || 'high-desert',
                    style: v.style || 'photorealistic',
                    image_url: v.image_url || '',
                    full_prompt: v.full_prompt || ''
                }));
            });
        });

        // Attach share button handlers
        grid.querySelectorAll('[data-share-id]').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                shareVision(btn.dataset.shareId, btn);
            });
        });
    }

    // ‚îÄ‚îÄ SHARE VISION TO GALLERY ‚îÄ‚îÄ
    async function shareVision(visionId, btn) {
        if (!window._vizSession) return;
        var shareIcon = '<svg class="share-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13" stroke-linecap="round" stroke-linejoin="round"/></svg>';

        btn.innerHTML = shareIcon + ' Sharing...';
        btn.disabled = true;

        var { error } = await sb.from('visions').update({ is_shared: true })
            .eq('id', visionId)
            .eq('user_id', window._vizSession.user.id);

        if (error) {
            btn.innerHTML = shareIcon + ' Share to gallery';
            btn.disabled = false;
            showError('Could not share ‚Äî try again.');
            return;
        }

        btn.innerHTML = shareIcon + ' Shared';
        btn.classList.add('shared');
        // Reload gallery to reflect change
        loadVisionGallery(window._vizSession.user.id);
    }

    // ‚îÄ‚îÄ CREDIT PICKUP FROM LIKES ‚îÄ‚îÄ
    async function pickupLikeCredits() {
        if (!window._vizSession) return;
        var userId = window._vizSession.user.id;

        // Sum all credit_earned from user's shared visions
        var { data, error } = await sb.from('visions')
            .select('credit_earned')
            .eq('user_id', userId)
            .eq('is_shared', true);

        if (error || !data) return;

        var totalEarned = data.reduce(function(sum, v) { return sum + (v.credit_earned || 0); }, 0);
        var claimedKey = 'earthback_viz_like_credits_claimed';
        var claimed = parseInt(localStorage.getItem(claimedKey) || '0');
        var unclaimed = totalEarned - claimed;

        if (unclaimed > 0) {
            // Add unclaimed credits to balance
            var creditData = getCredits();
            creditData.credits = Math.min(CREDIT_MAX, creditData.credits + unclaimed);
            saveCredits(creditData);
            localStorage.setItem(claimedKey, String(totalEarned));
            updateCounter();
        }
    }

    // Expose for use outside IIFE
    window._loadVisionGallery = loadVisionGallery;
    window._pickupLikeCredits = pickupLikeCredits;
})();

// ‚îÄ‚îÄ REPOPULATE FORM FROM GALLERY CLICK ‚îÄ‚îÄ
function repopulateVision(jsonStr) {
    var v = JSON.parse(jsonStr);

    // Set prompt text
    document.getElementById('promptInput').value = v.prompt;

    // Set structure chip
    var structureChips = document.getElementById('structureChips');
    structureChips.querySelectorAll('.chip').forEach(function(c) {
        c.classList.toggle('selected', c.dataset.value === v.structure);
    });

    // Set climate chip
    var climateChips = document.getElementById('climateChips');
    climateChips.querySelectorAll('.chip').forEach(function(c) {
        c.classList.toggle('selected', c.dataset.value === v.climate);
    });

    // Set style
    document.querySelectorAll('.style-option').forEach(function(o) {
        o.classList.toggle('selected', o.dataset.value === v.style);
    });

    // Show the saved image
    if (v.image_url) {
        var img = document.getElementById('generatedImage');
        var placeholder = document.getElementById('placeholderState');
        var loading = document.getElementById('loadingState');
        placeholder.style.display = 'none';
        loading.classList.remove('active');
        img.src = v.image_url;
        img.style.display = 'block';
        window.lastImageUrl = v.image_url;
        window.lastPrompt = v.prompt;
        window.lastFullPrompt = v.full_prompt || '';
    }

    // Mark save button as already saved (this vision came from the gallery)
    var saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.textContent = '‚úì Saved';
        saveBtn.disabled = true;
    }

    // Scroll to top of form
    document.querySelector('.page-header').scrollIntoView({ behavior: 'smooth' });
}

// ‚îÄ‚îÄ SAVE VISION TO SUPABASE (background, after render) ‚îÄ‚îÄ
async function saveVisionToSupabase(replicateUrl, fullPrompt) {
    var sb = window._vizSb;
    var session = window._vizSession;
    if (!sb || !session) return;

    var userId = session.user.id;
    var prompt = document.getElementById('promptInput').value.trim();
    var structure = getSelected('structureChips');
    var climate = getSelected('climateChips');
    var style = getStyleSelected();

    var saveBtn = document.getElementById('saveBtn');
    if (saveBtn) { saveBtn.textContent = 'Saving...'; saveBtn.disabled = true; }

    try {
        // 1. Fetch the image from Replicate as a blob
        var imgResponse = await fetch(replicateUrl);
        if (!imgResponse.ok) throw new Error('Failed to fetch image');
        var blob = await imgResponse.blob();

        // 2. Upload to Supabase Storage
        var timestamp = Date.now();
        var path = userId + '/' + timestamp + '.webp';
        var { error: uploadError } = await sb.storage.from('visions').upload(path, blob, {
            contentType: 'image/webp',
            upsert: false
        });

        var permanentUrl = '';
        if (!uploadError) {
            var { data: urlData } = sb.storage.from('visions').getPublicUrl(path);
            permanentUrl = urlData.publicUrl;
        } else {
            console.warn('Storage upload failed, saving with Replicate URL:', uploadError.message);
            permanentUrl = replicateUrl; // Fallback ‚Äî will expire but at least the record exists
        }

        // 3. Insert vision record
        var { error: insertError } = await sb.from('visions').insert({
            user_id: userId,
            prompt: prompt,
            structure: structure,
            climate: climate,
            style: style,
            image_url: permanentUrl,
            replicate_url: replicateUrl,
            full_prompt: fullPrompt || ''
        });

        if (insertError) {
            console.error('Vision save failed:', insertError.message);
            showError('Save failed: ' + insertError.message);
        } else {
            if (saveBtn) { saveBtn.textContent = '‚úì Saved'; }
            // Reload gallery
            if (window._loadVisionGallery) window._loadVisionGallery(userId);
        }
    } catch (err) {
        console.error('Vision save error:', err);
        showError('Could not save vision: ' + err.message);
    } finally {
        if (saveBtn) {
            setTimeout(function() {
                saveBtn.textContent = 'Save to profile';
                saveBtn.disabled = false;
            }, 2000);
        }
    }
}

// ‚îÄ‚îÄ DELETE VISION ‚îÄ‚îÄ
async function deleteVision(visionId) {
    if (!confirm('Delete this vision?')) return;
    var sb = window._vizSb;
    if (!sb) return;

    var { error } = await sb.from('visions').delete().eq('id', visionId);
    if (error) {
        showError('Delete failed: ' + error.message);
    } else {
        var session = window._vizSession;
        if (session && window._loadVisionGallery) {
            window._loadVisionGallery(session.user.id);
        }
    }
}
</script>

</body>
</html>
